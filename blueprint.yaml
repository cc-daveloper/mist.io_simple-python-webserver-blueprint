tosca_definitions_version: cloudify_dsl_1_2


imports:
  - http://www.getcloudify.org/spec/cloudify/3.3.1/types.yaml
  - http://raw.githubusercontent.com/mistio/cloudify-mist-plugin/master/plugin.yaml


inputs:
  mist_uri:
    description: >
      The Mist.io URI. Points to the Mist.io service that will handle the
      workflows' execution. You should NOT this input, unless you are running
      your own Mist.io installation. Defaults to the Mist.io SaaS.
    default: 'https://mist.io'
    type: string
#  mist_username:
#    description: >
#      The e-mail of the Mist.io user requesting to run this blueprint. Unless
#      a user runs this blueprint outside Mist.io (directly using a shell, for
#      instance), this input parameter does not need to be provided.
#    default: ''
#    type: string
#  mist_password:
#    description: >
#      The password associated with the e-mail address specified above. Provide
#      a password, in case an e-mail has also been provided in order to generate
#      a mist_token used to authenticate to the Mist.io API.
#    default: ''
#    type: string
  mist_token:
    description: >
      An API Token generated by Mist.io in order to be used with every request
      to authenticate to the Mist.io API. Either a username/password combo or
      a Mist.io Token has to be specified. In the former case, the username &
      password will be used in order to auto-generate an API Token to be used
      in subsequent API calls.
    default: ''
    type: string
  mist_cloud:
    description: >
      The ID of the Cloud on which the VM instances will be provisioned. This
      is the UUID assigned to a Cloud as soon as it has been added to Mist.io.
    type: string
  mist_image:
    description: >
      The ID of the Image to be used when provisioning a new VM. This has to
      be the ID as denoted by the IaaS provider. For instance, "ami-xxxxxxxx"
      in case of AWS.
    type: string
  mist_size:
    description: >
      The size of the VM. Instance sizes comprise varying combinations of CPU,
      memory, storage, and networking capacity. Sized need to be specified by
      their code name, such as "t2.micro" or "m2.large" in case of AWS.
    type: string
  mist_location:
    description: >
      The location/region to create resources in. If the IaaS supports regions,
      the region will have to be specified by its code and letter identifiers,
      such as "us-east-1" for US East (N. Virginia) in case of Amazon Services.
    default: ''
    type: string
  mist_key:
    description: >
      The ID or name of the SSH Key (which must already exist in Mist.io) to be
      deployed on the newly provisioned VM.
    default: ''
    type: string
  machine_name:
    description: The name to assign to the new VM.
    type: string
    default: 'yolo-machine'
  webserver_port:
    description: The HTTP web server port.
    default: 8000


node_templates:
  host:
    type: cloudify.mist.nodes.Server
    properties:
      mist_config:
        mist_uri: { get_input: mist_uri }
        mist_token: { get_input: mist_token }
      parameters:
        name: { get_input: machine_name }
        key: { get_input: mist_key }
        cloud_id: { get_input: mist_cloud }
        image_id: { get_input: mist_image }
        size_id: { get_input: mist_size }
        location_id: { get_input: mist_location }

  http_web_server:
    type: cloudify.nodes.WebServer
    properties:
      port: { get_input: webserver_port }
    relationships:
      - type: cloudify.relationships.contained_in
        target: host
    interfaces:
      cloudify.interfaces.lifecycle:
        create: install.py
        delete: uninstall.py

outputs:
  http_endpoint:
    description: Web server external endpoint
    value: { concat: ['http://', { get_attribute: [ host, ip ] }, ':',
                      { get_property: [ http_web_server, port] } ] }

workflows:
  touch: scripts/touch.py
