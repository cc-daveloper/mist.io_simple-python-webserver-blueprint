tosca_definitions_version: cloudify_dsl_1_3


imports:
  - http://www.getcloudify.org/spec/cloudify/3.4/types.yaml
  - http://raw.githubusercontent.com/mistio/cloudify-mist-plugin/reform_kube/plugin.yaml


inputs:
  webserver_port:
    description: >
      The HTTP web server port.
    default: 8000
  host_ip:
    default: localhost
  mist_uri:
    description: The mist custom uri
    default: 'https://mist.io'
  username:
    description: Mist.io username
    default: ''
  password:
    description: Mist.io password
    default: ''
  api_token:
    description: Mist.io api token
    default: ''
  cloud_id:
    default: ''
  machine_name:
    default: 'yolomachine'
  image_id:
    default: ''
  size_id:
    default: ''
  location_id:
    default: ''
  key_id:
    default: ''


node_templates:
  host:
    type: cloudify.mist.nodes.Server
    properties:
      ip: { get_input: host_ip }
      install_agent: false
      mist_config:
          mist_uri: { get_input: mist_uri }
          api_token: { get_input: api_token }
      parameters:
          cloud_id: { get_input: cloud_id }
          name: { get_input: machine_name }
          image_id: { get_input: image_id }
          size_id: { get_input: size_id }
          location_id: { get_input: location_id }
          key: { get_input: key_id }

  http_web_server:
    type: cloudify.nodes.WebServer
    properties:
      port: { get_input: webserver_port }
    relationships:
      - type: cloudify.relationships.contained_in
        target: host
    interfaces:
      cloudify.interfaces.lifecycle:
        create: install.py
        delete: uninstall.py


outputs:
  http_endpoint:
    description: Web server external endpoint
    value: { concat: ['http://', { get_property: [ host, ip ] },
                      ':', { get_property: [http_web_server, port] }] }
